<app-layout>
  <div class="commande-details-container">
    <!-- Loader et messages d'erreur -->
    <div *ngIf="isLoading" class="text-center loader-container">
      <div class="spinner-border" role="status">
        <span class="visually-hidden">Chargement...</span>
      </div>
      <p class="mt-3">Chargement des détails de la commande...</p>
    </div>

    <div *ngIf="errorMessage" class="alert alert-danger">
      {{ errorMessage }}
    </div>

    <div *ngIf="commande && !isLoading" class="min-h-screen bg-gradient-to-br from-gray-50 via-white to-blue-50 p-8">
      <div class="max-w-6xl mx-auto">
        <!-- En-tête -->
        <div class="text-center mb-8">
          <h1 class="text-4xl font-light text-gray-800 mb-2">
            Parcours de Commande
          </h1>
          <div class="flex items-center justify-center space-x-4 text-sm text-gray-600">
            <div class="flex items-center">
              <lucide-icon name="calendar" class="w-4 h-4 mr-1"></lucide-icon>
              <span>Commandé le {{ formatDate(commande.dateCreation) }}</span>
            </div>
            <div class="w-1 h-1 bg-gray-400 rounded-full"></div>
            <div class="flex items-center">
              <lucide-icon name="map-pin" class="w-4 h-4 mr-1"></lucide-icon>
              <span>Livraison {{ commande.ville }}</span>
            </div>
          </div>
        </div>

        <!-- Suivi circulaire -->
        <div class="relative w-full h-96 mb-12">
          <!-- Cercle de progression -->
          <div class="absolute inset-0 flex items-center justify-center">
            <svg class="transform -rotate-90 w-96 h-96">
              <circle
                cx="192"
                cy="192"
                r="180"
                stroke="#E5E7EB"
                stroke-width="3"
                fill="none"
                class="opacity-30"
              />
             <circle
  cx="192"
  cy="192"
  r="180"
  stroke="url(#gradient)"
  stroke-width="4"
  fill="none"
  [attr.stroke-dasharray]="2 * Math.PI * 180"
  [attr.stroke-dashoffset]="2 * Math.PI * 180 - (getCompletionPercentage(commande.statut) * 2 * Math.PI * 180)"
  class="transition-all duration-1000 ease-out drop-shadow-sm"
  stroke-linecap="round"
/>
              <defs>
                <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                  <stop offset="0%" stop-color="#10B981"></stop>
                  <stop offset="33%" stop-color="#3B82F6"></stop>
                  <stop offset="66%" stop-color="#8B5CF6"></stop>
                  <stop offset="100%" stop-color="#059669"></stop>
                </linearGradient>
              </defs>
            </svg>
          </div>
          
          <!-- Centre du cercle -->
          <div class="absolute inset-0 flex items-center justify-center">
            <div class="bg-white rounded-full w-32 h-32 shadow-xl border-4 border-gray-100 flex flex-col items-center justify-center">
              <div class="text-3xl font-bold text-gray-800">
{{ getCompletionPercentage(commande.statut) * 100 | number:'1.0-0' }}%
                  </div>
              <div class="text-xs text-gray-500 font-medium">PROGRESSION</div>
              <div class="text-xs text-gray-400 mt-1">
                {{ getStatusIndex(commande.statut) + 1 }}/{{ statuses.length }} étapes
              </div>
            </div>
          </div>
          
          <!-- Points de statut -->
          <div *ngFor="let status of statuses" 
     class="absolute transform -translate-x-1/2 -translate-y-1/2 transition-all duration-500"
     [style.top.%]="status.position.top"
     [style.left.%]="status.position.left">
  <div class="relative group" 
       [class.z-20]="getStatusIndex(commande.statut) === status.id - 1" 
       [class.z-10]="getStatusIndex(commande.statut) !== status.id - 1">
              <!-- Effet de halo pour le statut actif -->
              <div *ngIf="getStatusIndex(commande.statut) === status.id - 1" 
                   class="absolute inset-0 rounded-full blur-xl opacity-60 animate-pulse"
                   [style.backgroundColor]="status.color" 
                   style="transform: scale(1.5)"></div>
              
              <!-- Point de statut -->
              <div class="relative w-20 h-20 rounded-full border-4 transition-all duration-300 cursor-pointer hover:scale-110"
         [class.bg-white]="true"
         [class.border-green-400]="status.id - 1 < getStatusIndex(commande.statut)"
         [class.shadow-lg]="status.id - 1 < getStatusIndex(commande.statut)"
         [class.shadow-green-200]="status.id - 1 < getStatusIndex(commande.statut)"
         [class.border-gray-300]="status.id - 1 > getStatusIndex(commande.statut)"
         [class.bg-gray-50]="status.id - 1 > getStatusIndex(commande.statut)"
         [style.borderColor]="getStatusIndex(commande.statut) === status.id - 1 ? status.color : null"
         [style.boxShadow]="getStatusIndex(commande.statut) === status.id - 1 ? '0 0 30px ' + status.color + '40' : null">
                <div class="absolute inset-0 flex items-center justify-center">
                  <lucide-icon [name]="status.icon" 
                              [style.color]="status.id - 1 > getStatusIndex(commande.statut) ? '#9CA3AF' : status.color"
                              [class.animate-pulse]="getStatusIndex(commande.statut) === status.id - 1"></lucide-icon>
                </div>
                
                <!-- Numéro d'étape -->
                <div class="absolute -top-2 -right-2 w-6 h-6 rounded-full text-xs font-bold flex items-center justify-center text-white"
                     [style.backgroundColor]="getStatusIndex(commande.statut) === status.id - 1 ? status.color : (status.id - 1 < getStatusIndex(commande.statut) ? '#10B981' : '#9CA3AF')">
                  {{ status.id }}
                </div>
              </div>
              
              <!-- Info-bulle -->
              <div class="absolute top-24 left-1/2 transform -translate-x-1/2 w-48 bg-white rounded-xl shadow-xl p-4 border-t-4 pointer-events-none transition-all duration-300"
                   [style.borderTopColor]="status.color"
                   [style.opacity]="getStatusIndex(commande.statut) === status.id - 1 ? '1' : '0'"
                   [class.group-hover:opacity-100]="true">
                <div class="flex items-center mb-2">
                  <div class="w-8 h-8 rounded-lg flex items-center justify-center mr-3"
                       [style.backgroundColor]="status.lightColor">
                    <lucide-icon [name]="status.icon" [style.color]="status.color" size="16"></lucide-icon>
                  </div>
                  <div>
                    <h3 class="font-bold text-sm text-gray-800">{{ status.title }}</h3>
                    <p class="text-xs text-gray-500">{{ status.shortTitle }}</p>
                  </div>
                </div>
                <p class="text-xs text-gray-600 mb-3">{{ status.description }}</p>
                <div class="text-xs px-2 py-1 rounded-full text-center font-medium"
     [style.backgroundColor]="getStatusIndex(commande.statut) === status.id - 1 ? status.color : (status.id - 1 < getStatusIndex(commande.statut) ? '#D1FAE5' : '#F3F4F6')"
     [style.color]="getStatusIndex(commande.statut) === status.id - 1 ? 'white' : (status.id - 1 < getStatusIndex(commande.statut) ? '#065F46' : '#6B7280')">
  {{ status.id - 1 < getStatusIndex(commande.statut) ? '✓ Terminé' : (getStatusIndex(commande.statut) === status.id - 1 ? (status.id === 4 ? '✓ Terminé' : '● En cours') : '○ En attente') }}
</div>
                <div class="absolute -top-2 left-1/2 transform -translate-x-1/2 w-4 h-4 bg-white border-t border-l rotate-45"
                     style="border-color: #E5E7EB"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Carte du statut actuel -->
        <div class="bg-white rounded-2xl shadow-xl p-8 mb-8 border-t-4"
             [style.borderTopColor]="statuses[getStatusIndex(commande.statut)]?.color">
          <div class="flex items-center justify-between">
            <div class="flex items-center">
              <div class="w-16 h-16 rounded-xl flex items-center justify-center mr-6"
                   [style.backgroundColor]="statuses[getStatusIndex(commande.statut)]?.lightColor">
                <lucide-icon [name]="statuses[getStatusIndex(commande.statut)]?.icon" 
                             size="32"
                             [style.color]="statuses[getStatusIndex(commande.statut)]?.color"></lucide-icon>
              </div>
              <div>
                <h2 class="text-2xl font-bold text-gray-800 mb-1">
                  {{ statuses[getStatusIndex(commande.statut)]?.title }}
                </h2>
                <p class="text-gray-600">
                  {{ statuses[getStatusIndex(commande.statut)]?.description }}
                </p>
                <div class="flex items-center mt-2 text-sm text-gray-500">
                  <div class="w-2 h-2 rounded-full mr-2"
                       [style.backgroundColor]="statuses[getStatusIndex(commande.statut)]?.color"></div>
                  Étape {{ getStatusIndex(commande.statut) + 1 }} sur {{ statuses.length }} • En cours
                </div>
              </div>
            </div>
            
            <div class="text-right">
              
            </div>
          </div>
        </div>

        <!-- Détails de la commande -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Informations de commande -->
<div class="bg-white rounded-xl shadow-lg p-6">
  <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
    <lucide-icon name="file-text" class="w-5 h-5 mr-2 text-blue-600"></lucide-icon>
    Détails Commande
  </h3>
  <div class="space-y-3">
    <div class="flex justify-between items-center py-2 border-b border-gray-100">
      <span class="text-gray-600 flex items-center">
        <lucide-icon name="hash" class="w-4 h-4 mr-2 text-gray-400"></lucide-icon>
        Référence
      </span>
      <span class="font-semibold text-gray-800">#{{ commande.numeroCommande }}</span>
    </div>
    
    <div class="flex justify-between items-center py-2 border-b border-gray-100">
      <span class="text-gray-600 flex items-center">
        <lucide-icon name="credit-card" class="w-4 h-4 mr-2 text-gray-400"></lucide-icon>
        Montant TTC
      </span>
      <span class="font-semibold">{{ commande.montantTotalTTC | currency:'TND' }}</span>
    </div>

    <div class="flex justify-between items-center py-2 border-b border-gray-100">
      <span class="text-gray-600 flex items-center">
        <lucide-icon name="activity" class="w-4 h-4 mr-2 text-gray-400"></lucide-icon>
        Statut
      </span>
      <span class="font-semibold" [style.color]="statuses[getStatusIndex(commande.statut)]?.color">
        {{ getStatusLabel(commande.statut) }}
      </span>
    </div>
    
    <div class="flex justify-between items-center py-2">
      <span class="text-gray-600 flex items-center">
        <lucide-icon name="map-pin" class="w-4 h-4 mr-2 text-gray-400"></lucide-icon>
        Adresse
      </span>
      <span class="font-semibold text-gray-800 text-right">
        {{ commande.adresseLivraison }}<br>
        {{ commande.codePostal }} {{ commande.ville }}
      </span>
    </div>
  </div>
</div>
          <!-- Articles commandés -->
         <!-- Articles commandés -->
<div class="bg-white rounded-xl shadow-lg p-6">
  <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
    <lucide-icon name="shopping-cart" class="w-5 h-5 mr-2 text-green-600"></lucide-icon>
    Articles commandés
  </h3>
  <div *ngFor="let item of commande.lignesCommande" class="flex items-center py-3 border-b border-gray-100 last:border-0">
    <div class="w-16 h-16 rounded-lg bg-gray-100 flex items-center justify-center mr-4">
  <img *ngIf="getImageUrl(item); else defaultIcon" 
       [src]="getImageUrl(item)" 
       [alt]="item.nomProduit"
       (error)="onImageError($event)"
       class="max-w-full max-h-full object-contain">
  <ng-template #defaultIcon>
    <lucide-icon [name]="item.typeProduit === 'BASSIN_STANDARD' ? 'package' : 'box-select'" 
                class="text-gray-400 w-8 h-8"></lucide-icon>
  </ng-template>
</div>
    <div class="flex-1">
      <h4 class="font-medium text-gray-800">{{ item.nomProduit }}</h4>
      <p class="text-sm text-gray-500 flex items-center">
        <lucide-icon name="shopping-bag" class="w-3 h-3 mr-1"></lucide-icon>
        Qté: {{ item.quantite }}
      </p>
    </div>
    <div class="text-right">
      <div class="font-semibold flex items-center justify-end">
        <lucide-icon name="tag" class="w-4 h-4 mr-1 text-gray-500"></lucide-icon>
        {{ item.prixTotal | currency:'TND':'symbol':'1.2-2':'fr-FR' }}
      </div>
    </div>
  </div>
</div>
          
          
        </div>
      </div>
    </div>
  </div>
</app-layout>